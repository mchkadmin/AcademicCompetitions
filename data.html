<!DOCTYPE html>
<html>
<head>
    <title>MCHK Approved Competitions Dataset</title>
    <style>
        /* Basic styling for demonstration */
        body { font-family: Arial, sans-serif; padding: 20px; }
        #filter-controls { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        #competitions-table { width: 100%; border-collapse: collapse; }
        #competitions-table th, #competitions-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    </style>
</head>
<body>
    <h1>MCHK Approved Competitions</h1>

    <div id="filter-controls">
        <h3>Filter Competitions</h3>
        
        <label for="category-filter">Category:</label>
        <select id="category-filter" onchange="applyFilters()">
            <option value="">All Categories</option>
            </select>
        
        <label for="difficulty-filter">Difficulty (1-5):</label>
        <select id="difficulty-filter" onchange="applyFilters()">
            <option value="">All Difficulties</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
        </select>
        
        <label for="year-filter">Season:</label>
        <select id="year-filter" onchange="applyFilters()">
            <option value="">All Seasons</option>
            </select>
    </div>

    <table id="competitions-table">
        <thead></thead>
        <tbody id="table-body">
            <tr><td colspan="10">Loading data...</td></tr>
        </tbody>
    </table>

    <script>

// --- Initialization ---

let rawData = [];
let mchkApprovedData = [];

const MCHK_HEADER = "Approved for MCHK";
const DIFFICULTY_HEADER = "Difficulty (1-5)";
const PRIMARY_CATEGORY_HEADER = "Category";
const SEASON_HEADER = "Season";

async function loadData() {
    try {
        const response = await fetch('competitions.json');
        const jsonText = await response.text();
        rawData = JSON.parse(jsonText);
        
        // --- üö® NEW: Standardize Data Types Immediately ---
        rawData.forEach(item => {
            // Force conversion of the Difficulty header to a true integer
            if (item.hasOwnProperty(DIFFICULTY_HEADER)) {
                item[DIFFICULTY_HEADER] = parseInt(item[DIFFICULTY_HEADER], 10);
            }
        });
        // -------------------------------------------------
        
        // 1. Apply Initial Filter: Only keep Approved for MCHK=TRUE
        mchkApprovedData = rawData.filter(item => item[MCHK_HEADER] === 'TRUE');
        
        if (mchkApprovedData.length === 0) {
            document.getElementById('table-body').innerHTML = '<tr><td colspan="10">No MCHK Approved Competitions found.</td></tr>';
            return;
        }

        const headers = Object.keys(mchkApprovedData[0]); 
        
        createTableHeaders(headers);
        populateFilters(mchkApprovedData);
        displayData(mchkApprovedData);
        
    } catch (error) {
        console.error("Error loading JSON:", error);
        document.getElementById('table-body').innerHTML = '<tr><td colspan="10">Error loading data. See console.</td></tr>';
    }
}
// -----------------------------------------------------

// --- Dynamic Table Creation ---

function createTableHeaders(headers) {
    const thead = document.querySelector('#competitions-table thead');
    thead.innerHTML = ''; // Clear existing
    const row = thead.insertRow();
    
    headers.forEach(header => {
        // Exclude the approval column from the display, since we've already filtered by it
        if (header !== MCHK_HEADER) {
            const th = document.createElement('th');
            th.textContent = header;
            row.appendChild(th);
        }
    });
}

function displayData(data) {
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = ''; 
    
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10">No results match your filters.</td></tr>';
        return;
    }
    
    const headers = Object.keys(data[0]);

    data.forEach(item => {
        const row = tbody.insertRow();
        
        headers.forEach(header => {
            // Again, skip the MCHK approval column for display
            if (header !== MCHK_HEADER) {
                const cell = row.insertCell();
                let value = item[header];
                
                // Special handling for boolean/checkbox columns
                if (value === 'TRUE') {
                    cell.innerHTML = '‚úÖ';
                } else if (value === 'FALSE') {
                    cell.innerHTML = '‚ùå';
                } else {
                    cell.textContent = value;
                }
            }
        });
    });
}

// --- Filter Population ---

// --- Updated populateFilters function (REPLACE the old one) ---

const PRIMARY_CATEGORY_HEADER = "Category"; // <--- New constant for clarity

function populateFilters(data) {
    const categorySelect = document.getElementById('category-filter');
    const yearSelect = document.getElementById('year-filter');
    
    // Clear old options while preserving the default "All Categories"
    categorySelect.querySelectorAll('option:not(:first-child)').forEach(o => o.remove());

    const primaryCategories = new Set(); // For Math, Science, etc.
    const secondaryCategories = new Set(); // For P1, P2, etc. (still useful)
    const seasons = new Set();

    // 1. Extract Primary Categories (Math, Science)
    data.forEach(item => {
        if (item[PRIMARY_CATEGORY_HEADER]) {
            primaryCategories.add(item[PRIMARY_CATEGORY_HEADER]);
        }
        
        // 2. Extract Secondary Categories (P1, P2 - keeping this as it may be useful)
        Object.keys(item).forEach(key => {
            if (key.match(/^P\d/) && item[key] === 'TRUE') { 
                secondaryCategories.add(key);
            }
        });
        
        // 3. Extract Seasons/Years (unchanged)
        if (item[SEASON_HEADER]) {
            seasons.add(item[SEASON_HEADER]);
        }
    });

    // Populate Primary Category Filter (Math, Science, etc.)
    // We will use the Primary Category filter as the main "Category" selection
    Array.from(primaryCategories).sort().forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
    });
    
    // --- NOTE: We are NOT populating P1, P2, etc. into the main category-filter now ---
    // If you need P1/P2 filters, you must add another <select> box in your HTML.

    // Populate Season/Year Filter (unchanged)
    yearSelect.querySelectorAll('option:not(:first-child)').forEach(o => o.remove());
    Array.from(seasons).sort().forEach(season => {
        const option = document.createElement('option');
        option.value = season;
        option.textContent = season;
        yearSelect.appendChild(option);
    });
}

// --- Core Filtering Logic ---


function applyFilters() {
    const primaryCategoryFilter = document.getElementById('category-filter').value; 
    const difficultyFilter = document.getElementById('difficulty-filter').value;
    const yearFilter = document.getElementById('year-filter').value;

    let filteredData = mchkApprovedData;

    // Filter 1: Primary Category
    if (primaryCategoryFilter) {
        filteredData = filteredData.filter(item => item[PRIMARY_CATEGORY_HEADER] === primaryCategoryFilter);
    }

    // Filter 2: Difficulty - Clean and direct comparison
    if (difficultyFilter) {
        // Convert the string filter value to an integer
        const filterNumber = parseInt(difficultyFilter, 10); 
        
        filteredData = filteredData.filter(item => 
            // Compare Number to Number (guaranteed by the loadData fix)
            item[DIFFICULTY_HEADER] === filterNumber 
        );
    }
    
    // Filter 3: Season/Year
    if (yearFilter) {
        filteredData = filteredData.filter(item => item[SEASON_HEADER] === yearFilter);
    }

    displayData(filteredData);
}
// -----------------------------------------------------

// Start the process
loadData();
    </script>
</body>
</html>
